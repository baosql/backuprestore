# Define SQL Server connection
$server   = "sql01"
$database = "sumodb"

# Query to check database size and biggest objects
$query = @"
;WITH ObjSizes AS
(
    SELECT 
        t.NAME AS TableName,
        i.name AS IndexName,
        SUM(p.rows) AS RowCounts,
        SUM(a.total_pages) * 8 / 1024 AS TotalSizeMB,
        SUM(a.used_pages) * 8 / 1024 AS UsedSizeMB,
        SUM(a.data_pages) * 8 / 1024 AS DataSizeMB
    FROM sys.tables t
    INNER JOIN sys.indexes i ON t.OBJECT_ID = i.object_id
    INNER JOIN sys.partitions p ON i.object_id = p.OBJECT_ID AND i.index_id = p.index_id
    INNER JOIN sys.allocation_units a ON p.partition_id = a.container_id
    WHERE t.is_ms_shipped = 0
    GROUP BY t.NAME, i.object_id, i.index_id, i.name
)
SELECT 
    TableName,
    ISNULL(IndexName,'HEAP') AS IndexName,
    RowCounts,
    TotalSizeMB,
    DataSizeMB,
    (TotalSizeMB - DataSizeMB) AS IndexOverheadMB
FROM ObjSizes
ORDER BY TotalSizeMB DESC;
"@

# Run the query
Invoke-Sqlcmd -ServerInstance $server -Database $database -Query $query |
    Export-Csv "C:\Temp\sumodb_growth_report.csv" -NoTypeInformation
